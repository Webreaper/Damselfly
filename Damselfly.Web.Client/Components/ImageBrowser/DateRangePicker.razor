<div class="date-picker">
    <div class="filter-type">
        <MudSelect Label="Date Filter" T="DateShortcut?" @bind-Value="@SelectedShortCut" @bind-Value:after="ShortCutChanged"
                   Clearable="true" Dense="true" Margin="Margin.Dense" Variant="UIConstants.MudVariant">
            @foreach ( var choice in DateRanges )
            {
                <MudSelectItem Value="@choice">@choice.name</MudSelectItem>
            }
        </MudSelect>
    </div>
        @if( SelectedShortCut != null && SelectedShortCut.range == null )
        {
            <div class="date-wheels">
                <MudDateWheelPicker @bind-Value="startDate" @bind-Value:after="StartDateChanged" Label="Start"
                                Clearable="true" MaxDate="@DateRange?.End" DateFormat="dd-MMM-yyyy" Class="date-wheel"/>
                <MudDateWheelPicker @bind-Value="endDate" @bind-Value:after="EndDateChanged" Label="End"
                                Clearable="true" MaxDate="@DateTime.UtcNow" DateFormat="dd-MMM-yyyy" Class="date-wheel"/>
            </div>
        }
</div>

@code {
    [Parameter] public DateRange? DateRange { get; set; }
    
    [Parameter] public EventCallback<DateRange?> DateRangeChanged { get; set; }

    private record DateShortcut( string name, DateRange? range);
    private readonly List<DateShortcut> DateRanges = new();
    private DateShortcut? SelectedShortCut = null;
    private DateTime? startDate = null;
    private DateTime? endDate = null;

    protected override void OnInitialized()
    {
        CreateShortcuts();

        base.OnInitialized();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        startDate = DateRange?.Start;
        endDate = DateRange?.End;
        
        await base.OnParametersSetAsync();
    }
    
    private async Task StartDateChanged()
    {
        DateRange = new DateRange(startDate, endDate);
        SelectedShortCut = DateRanges.FirstOrDefault(x => x.range == null);

        await DateRangeChanged.InvokeAsync(DateRange);
    }

    private async Task EndDateChanged()
    {
        if( endDate != null )
            endDate = new DateTime(endDate.Value.Year, endDate.Value.Month, endDate.Value.Day, 23, 59, 59);

        DateRange = new DateRange(startDate, endDate);

        SelectedShortCut = DateRanges.FirstOrDefault(x => x.range == null);

        await DateRangeChanged.InvokeAsync(DateRange);
    }

    private async Task ShortCutChanged()
    {
        if( SelectedShortCut != null )
        {
            DateRange = SelectedShortCut.range;
            if( DateRange == null )
                DateRange = new DateRange(startDate, endDate);
        }
        else
        {
            DateRange = null;
            startDate = null;
            endDate = null;
        }

        await DateRangeChanged.InvokeAsync(DateRange);
    }

    private void AddRangeShortcut(string name, DateRange? range)
    {
        DateRanges.Add(new DateShortcut(name, range));
    }

    private void CreateShortcuts()
    {
        // TODO: Add more here
        var Jan1ThisYear = new DateTime(DateTime.UtcNow.Year, 1, 1);

        AddRangeShortcut("Custom", null);
        AddRangeShortcut("This year", new DateRange { Start = Jan1ThisYear, End = DateTime.UtcNow });
        AddRangeShortcut("Last year", new DateRange { Start = Jan1ThisYear.AddYears(-1), End = Jan1ThisYear.AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-2).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-2), End = Jan1ThisYear.AddYears(-1).AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-3).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-3), End = Jan1ThisYear.AddYears(-2).AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-4).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-4), End = Jan1ThisYear.AddYears(-3).AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-5).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-5), End = Jan1ThisYear.AddYears(-4).AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-10).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-10), End = Jan1ThisYear.AddYears(-9).AddSeconds(-1) });
        AddRangeShortcut($"{Jan1ThisYear.AddYears(-15).Year}", new DateRange { Start = Jan1ThisYear.AddYears(-15), End = Jan1ThisYear.AddYears(-14).AddSeconds(-1) });
    }
}